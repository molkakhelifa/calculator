cd ~/calculator
git checkout master

cat > Jenkinsfile-Dev << 'EOF'
pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "calculator-app"
        DOCKER_TAG = "dev-${BUILD_NUMBER}"
        APP_PORT = "3002"
        CONTAINER_NAME = "calc-dev"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "Stage 1: Checkout"
                checkout scm
            }
        }
        
        stage('Setup') {
            steps {
                echo "Stage 2: Setup"
                sh 'docker rm -f ${CONTAINER_NAME} 2>/dev/null || true'
            }
        }
        
        stage('Build') {
            steps {
                echo "Stage 3: Build"
                sh 'docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .'
            }
        }
        
        stage('Run') {
            steps {
                echo "Stage 4: Run"
                sh '''
                    docker run -d \
                        --name ${CONTAINER_NAME} \
                        --network bridge \
                        -p ${APP_PORT}:80 \
                        ${DOCKER_IMAGE}:${DOCKER_TAG}
                    sleep 10
                    docker ps | grep ${CONTAINER_NAME}
                '''
            }
        }
        
        stage('Smoke Test') {
            steps {
                echo "Stage 5: Smoke Test"
                sh '''
                    # Tester depuis le host via le port publié
                    for i in {1..15}; do
                        if curl -f -s http://host.docker.internal:${APP_PORT} > /dev/null 2>&1; then
                            echo "Test PASSED - Application is responding"
                            exit 0
                        fi
                        echo "Attempt $i/15..."
                        sleep 2
                    done
                    
                    # Si échec, essayer avec l'IP du container
                    CONTAINER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${CONTAINER_NAME})
                    echo "Trying container IP: $CONTAINER_IP"
                    
                    if curl -f -s http://$CONTAINER_IP:80 > /dev/null 2>&1; then
                        echo "Test PASSED - Application responding on container IP"
                        exit 0
                    else
                        echo "Test FAILED - Application not responding"
                        docker logs ${CONTAINER_NAME}
                        exit 1
                    fi
                '''
            }
        }
        
        stage('Archive') {
            steps {
                echo "Stage 6: Archive"
                sh '''
                    mkdir -p artifacts
                    docker logs ${CONTAINER_NAME} > artifacts/logs.txt 2>&1
                    docker inspect ${DOCKER_IMAGE}:${DOCKER_TAG} > artifacts/image.json
                    echo "Build ${BUILD_NUMBER} - SUCCESS" > artifacts/status.txt
                '''
                archiveArtifacts artifacts: 'artifacts/**/*'
            }
        }
        
        stage('Cleanup') {
            steps {
                echo "Stage 7: Cleanup"
                sh 'docker stop ${CONTAINER_NAME} && docker rm ${CONTAINER_NAME}'
            }
        }
    }
    
    post {
        always {
            sh 'docker stop ${CONTAINER_NAME} 2>/dev/null || true'
            sh 'docker rm ${CONTAINER_NAME} 2>/dev/null || true'
        }
    }
}
EOF

