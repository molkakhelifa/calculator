pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "calculator-app"
        DOCKER_TAG = "dev-${BUILD_NUMBER}"
        APP_PORT = "3002"
        CONTAINER_NAME = "calc-dev"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "Stage 1: Checkout"
                checkout scm
            }
        }
        
        stage('Setup') {
            steps {
                echo "Stage 2: Setup"
                sh 'docker rm -f ${CONTAINER_NAME} 2>/dev/null || true'
            }
        }
        
        stage('Build') {
            steps {
                echo "Stage 3: Build"
                sh 'docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .'
            }
        }
        
        stage('Run') {
            steps {
                echo "Stage 4: Run"
                sh '''
                    docker run -d --name ${CONTAINER_NAME} -p ${APP_PORT}:80 ${DOCKER_IMAGE}:${DOCKER_TAG}
                    sleep 10
                '''
            }
        }
        
        stage('Smoke Test') {
            steps {
                echo "Stage 5: Smoke Test"
                sh '''
                    echo "Checking if container is running..."
                    docker ps | grep ${CONTAINER_NAME}
                    
                    echo "Getting container IP..."
                    CONTAINER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${CONTAINER_NAME})
                    echo "Container IP: $CONTAINER_IP"
                    
                    echo "Testing application inside container..."
                    if docker exec ${CONTAINER_NAME} wget -q -O- http://localhost:80 | grep -q "html"; then
                        echo "SUCCESS: Application is serving HTML"
                    else
                        echo "FAILED: Application not responding"
                        docker logs ${CONTAINER_NAME}
                        exit 1
                    fi
                    
                    echo "All smoke tests PASSED"
                '''
            }
        }
        
        stage('Archive') {
            steps {
                echo "Stage 6: Archive"
                sh '''
                    mkdir -p artifacts
                    docker logs ${CONTAINER_NAME} > artifacts/logs.txt 2>&1
                    docker inspect ${DOCKER_IMAGE}:${DOCKER_TAG} > artifacts/image.json
                    echo "Build ${BUILD_NUMBER} - SUCCESS" > artifacts/status.txt
                '''
                archiveArtifacts artifacts: 'artifacts/**/*'
            }
        }
        
        stage('Cleanup') {
            steps {
                echo "Stage 7: Cleanup"
                sh 'docker stop ${CONTAINER_NAME} && docker rm ${CONTAINER_NAME}'
            }
        }
    }
    
    post {
        always {
            sh 'docker stop ${CONTAINER_NAME} 2>/dev/null || true'
            sh 'docker rm ${CONTAINER_NAME} 2>/dev/null || true'
        }
    }
}
