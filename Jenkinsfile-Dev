pipeline {
    agent any

    environment {
        APP_NAME = "calculator-app"
        DEV_TAG = "dev-${BUILD_NUMBER}"
        CONTAINER_NAME = "calc-dev"
    }

    stages {

        stage('Checkout') {
            steps {
                echo "Stage 1: Checkout"
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                echo "Stage 2: Setup"
                sh "docker rm -f ${CONTAINER_NAME} || true"
            }
        }

        stage('Build') {
            steps {
                echo "Stage 3: Build"
                sh "docker build -t ${APP_NAME}:${DEV_TAG} ."
            }
        }

        stage('Run') {
            steps {
                echo "Stage 4: Run"
                sh """
                    docker run -d --name ${CONTAINER_NAME} \
                    -p 3002:80 ${APP_NAME}:${DEV_TAG}
                """
                sh "sleep 10"
            }
        }

        stage('Smoke Test') {
            steps {
                echo "Stage 5: Smoke Test"
                sh """
                    docker ps | grep ${CONTAINER_NAME}

                    echo "Checking app response..."

                    # Escape dollar signs inside Groovy multiline string
                    CONTAINER_IP=\$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${CONTAINER_NAME})
                    echo "Container IP: \${CONTAINER_IP}"

                    if docker exec ${CONTAINER_NAME} wget -q -O- http://0.0.0.0:80 >/dev/null; then
                        echo "APP OK"
                    else
                        echo "APP NOT RESPONDING"
                        exit 1
                    fi
                """
            }
        }
    }

    post {
        always {
            sh "docker stop ${CONTAINER_NAME} || true"
            sh "docker rm ${CONTAINER_NAME} || true"
        }
    }
}
