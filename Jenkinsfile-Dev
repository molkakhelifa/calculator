pipeline {
    agent any

    environment {
        APP_NAME = "calculator-app"
        DEV_TAG = "dev-${BUILD_NUMBER}"
        CONTAINER_NAME = "calc-dev"
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Stage 1: Checkout"
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                echo "Stage 2: Setup"
                sh "docker rm -f ${CONTAINER_NAME} || true"
            }
        }

        stage('Build') {
            steps {
                echo "Stage 3: Build"
                sh "docker build -t ${APP_NAME}:${DEV_TAG} ."
            }
        }

        stage('Run') {
            steps {
                echo "Stage 4: Run"
                sh """
                    docker run -d --name ${CONTAINER_NAME} \
                    -p 3002:80 ${APP_NAME}:${DEV_TAG}
                """
                sh "sleep 10"
            }
        }

        stage('Smoke Test') {
            steps {
                echo "Stage 5: Smoke Test"
                sh """
                    docker ps | grep ${CONTAINER_NAME}
                    echo "✅ Container is running"

                    # Get container internal IP
                    CONTAINER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${CONTAINER_NAME})
                    echo "Container IP: \$CONTAINER_IP"

                    # Correct smoke test: use 0.0.0.0 instead of localhost
                    if docker exec ${CONTAINER_NAME} wget -q -O- http://0.0.0.0:80 >/dev/null; then
                        echo "✅ Application is responding"
                    else
                        echo "❌ Application not responding"
                        exit 1
                    fi
                """
            }
        }

        stage('Archive') {
            when {
                expression { currentBuild.currentResult == "SUCCESS" }
            }
            steps {
                echo "Stage 6: Archive"
            }
        }
    }

    post {
        always {
            echo "Cleaning up..."
            sh "docker stop ${CONTAINER_NAME} || true"
            sh "docker rm ${CONTAINER_NAME} || true"
        }
    }
}
