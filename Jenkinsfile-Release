pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "calculator-app"
        APP_PORT = "3003"
        CONTAINER_NAME = "calc-release"
    }

    stages {
        stage('Checkout') {
            steps {
                // Forcer la branche master
                checkout([$class: 'GitSCM',
                    branches: [[name: 'refs/heads/master']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/molkakhelifa/calculator.git',
                        credentialsId: 'github-creds'
                    ]]
                ])
                script {
                    // Récupérer tous les tags
                    sh 'git fetch --tags'
                    // Récupérer le dernier tag Git, fallback sur master si aucun tag
                    env.VERSION = sh(script: "git describe --tags --abbrev=0 || echo 'master'", returnStdout: true).trim()
                }
                echo "Stage 1: Checkout version ${env.VERSION}"
            }
        }

        stage('Setup') {
            steps {
                echo "Stage 2: Setup"
                sh 'mkdir -p release && docker rm -f ${CONTAINER_NAME} 2>/dev/null || true'
            }
        }

        stage('Build') {
            steps {
                echo "Stage 3: Build ${env.VERSION}"
                sh 'docker build -t ${DOCKER_IMAGE}:${env.VERSION} -t ${DOCKER_IMAGE}:latest .'
            }
        }

        stage('Run') {
            steps {
                echo "Stage 4: Run"
                sh '''
                    docker run -d --name ${CONTAINER_NAME} -p ${APP_PORT}:80 ${DOCKER_IMAGE}:${env.VERSION}
                    sleep 5
                '''
            }
        }

        stage('Smoke Test') {
            steps {
                echo "Stage 5: Smoke Test"
                sh 'chmod +x ./smoke-test.sh'
                sh 'APP_URL=http://localhost:${APP_PORT} ./smoke-test.sh'
            }
        }

        stage('Archive') {
            steps {
                echo "Stage 6: Archive"
                sh '''
                    docker save ${DOCKER_IMAGE}:${env.VERSION} | gzip > release/calculator-${env.VERSION}.tar.gz
                    echo "Release ${env.VERSION}" > release/notes.txt
                    tar -czf release-${env.VERSION}.tar.gz release/
                '''
                archiveArtifacts artifacts: 'release-*.tar.gz'
            }
        }

        stage('Cleanup') {
            steps {
                echo "Stage 7: Cleanup"
                sh 'docker stop ${CONTAINER_NAME} 2>/dev/null || true'
                sh 'docker rm ${CONTAINER_NAME} 2>/dev/null || true'
            }
        }
    }

    post {
        always {
            sh 'docker stop ${CONTAINER_NAME} 2>/dev/null || true'
            sh 'docker rm ${CONTAINER_NAME} 2>/dev/null || true'
        }
    }
}
